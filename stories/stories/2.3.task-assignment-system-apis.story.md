# Story 2.3: Task Assignment System APIs

## Status
Draft

## Story
**As a** Lead MR or Admin user,
**I want** comprehensive task assignment APIs and management system,
**so that** I can efficiently assign tasks to field teams, track progress, and coordinate area-specific activities

## Acceptance Criteria
1. Enhanced task management APIs with advanced assignment capabilities
2. Task assignment logic supports area-specific requirements
3. Task status tracking and progress monitoring APIs
4. Task notification system for assigned MRs
5. Task filtering and search functionality by region, area, and status
6. Task completion workflow with validation
7. Task priority and due date management
8. Task assignment conflict prevention
9. Task performance analytics and reporting
10. Task template system for recurring assignments
11. Task bulk operations for efficient management
12. Task audit trail and history tracking

## Tasks / Subtasks
- [ ] Enhance task management APIs (AC: 1, 5)
  - [ ] Implement advanced task filtering by region, area, status, priority
  - [ ] Add task search functionality across title, description, assigned user
  - [ ] Create task pagination and sorting capabilities
  - [ ] Implement task statistics and summary endpoints
  - [ ] Add task export functionality for reporting
- [ ] Implement task assignment logic (AC: 2, 8)
  - [ ] Create area-specific task assignment algorithms
  - [ ] Implement assignment conflict detection and prevention
  - [ ] Add automatic assignment based on MR availability
  - [ ] Create manual assignment override capabilities
  - [ ] Implement assignment validation and constraints
- [ ] Build task status tracking system (AC: 3, 6)
  - [ ] Create task status update endpoints
  - [ ] Implement task completion workflow with validation
  - [ ] Add task progress tracking and milestones
  - [ ] Create task status history and audit trail
  - [ ] Implement task status change notifications
- [ ] Implement task notification system (AC: 4)
  - [ ] Create push notification endpoints for task assignments
  - [ ] Implement in-app notification system
  - [ ] Add email notification capabilities
  - [ ] Create notification preferences and settings
  - [ ] Implement notification delivery tracking
- [ ] Add task priority and due date management (AC: 7)
  - [ ] Implement task priority levels (High, Medium, Low)
  - [ ] Create due date validation and reminders
  - [ ] Add overdue task detection and alerts
  - [ ] Implement priority-based task sorting
  - [ ] Create deadline extension capabilities
- [ ] Build task performance analytics (AC: 9)
  - [ ] Create task completion rate analytics
  - [ ] Implement task efficiency metrics
  - [ ] Add team performance comparisons
  - [ ] Create task trend analysis
  - [ ] Implement performance reporting endpoints
- [ ] Implement task template system (AC: 10)
  - [ ] Create task template management APIs
  - [ ] Implement template-based task creation
  - [ ] Add recurring task scheduling
  - [ ] Create template customization options
  - [ ] Implement template sharing and collaboration
- [ ] Add task bulk operations (AC: 11)
  - [ ] Create bulk task assignment endpoints
  - [ ] Implement bulk status updates
  - [ ] Add bulk task deletion with validation
  - [ ] Create bulk task export functionality
  - [ ] Implement bulk task import capabilities
- [ ] Implement task audit trail (AC: 12)
  - [ ] Create task history tracking system
  - [ ] Implement task change logging
  - [ ] Add task activity timeline
  - [ ] Create task audit reporting
  - [ ] Implement task accountability tracking

## Dev Notes

### Previous Story Insights
This story builds on Epic 1 (Stories 1.1-1.5) and Stories 2.1-2.2. The developer should have:
- Complete Next.js foundation with TypeScript and Prisma
- MongoDB schema with Task models
- User authentication system with role-based access
- Core API endpoints infrastructure
- Client management and GPS tracking systems

### Data Models
**Enhanced Task Model (from Story 1.2):**
```typescript
model Task {
  id          String     @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String?
  region      String
  area        String
  priority    TaskPriority @default(MEDIUM)
  dueDate     DateTime?
  assignedTo  String?    @db.ObjectId
  assignedBy  String     @db.ObjectId
  status      TaskStatus @default(PENDING)
  completedAt DateTime?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  assignedUser User? @relation("AssignedTasks", fields: [assignedTo], references: [id])
  createdByUser User @relation("CreatedTasks", fields: [assignedBy], references: [id])
  taskHistory  TaskHistory[]
  notifications TaskNotification[]

  @@index([assignedTo])
  @@index([region, area])
  @@index([status])
  @@index([dueDate])
  @@index([priority])
}

enum TaskPriority {
  HIGH
  MEDIUM
  LOW
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
  OVERDUE
}

model TaskHistory {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  taskId    String   @db.ObjectId
  task      Task     @relation(fields: [taskId], references: [id])
  action    String   // ASSIGNED, STATUS_CHANGED, COMPLETED, etc.
  oldValue  String?
  newValue  String?
  changedBy String   @db.ObjectId
  user      User     @relation(fields: [changedBy], references: [id])
  timestamp DateTime @default(now())

  @@index([taskId])
  @@index([timestamp])
}

model TaskNotification {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  taskId    String   @db.ObjectId
  task      Task     @relation(fields: [taskId], references: [id])
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id])
  type      NotificationType
  message   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([taskId])
  @@index([userId])
  @@index([isRead])
}

enum NotificationType {
  TASK_ASSIGNED
  TASK_DUE_SOON
  TASK_OVERDUE
  TASK_COMPLETED
  TASK_UPDATED
}

model TaskTemplate {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String?
  region      String?
  area        String?
  priority    TaskPriority @default(MEDIUM)
  estimatedDuration Int? // in minutes
  createdBy   String   @db.ObjectId
  user        User     @relation(fields: [createdBy], references: [id])
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([createdBy])
  @@index([isActive])
}
```

[Source: docs/architecture/backend-architecture.md#database-schema-design]

### API Specifications
**Enhanced Task Management APIs:**
```
GET /api/tasks
- Query params: assignedTo?, region?, area?, status?, priority?, dueDate?, search?
- Response: PaginatedResponse<Task[]> with role-based filtering
- Auth: All authenticated users (filtered by role)

POST /api/tasks
- Body: { title, description?, region, area, priority?, dueDate?, assignedTo? }
- Response: Created task data
- Auth: Lead MR, Admin

PUT /api/tasks/[id]
- Body: { title?, description?, region?, area?, priority?, dueDate?, assignedTo? }
- Response: Updated task data
- Auth: Lead MR, Admin

DELETE /api/tasks/[id]
- Response: { success: boolean }
- Auth: Lead MR, Admin

GET /api/tasks/[id]
- Response: Task with history and notifications
- Auth: Assigned user, Lead MR, Admin
```

**Task Assignment APIs:**
```
POST /api/tasks/[id]/assign
- Body: { assignedTo: string, reason?: string }
- Response: { success: boolean, task: Task }
- Auth: Lead MR, Admin

POST /api/tasks/[id]/unassign
- Response: { success: boolean }
- Auth: Lead MR, Admin

POST /api/tasks/assign-bulk
- Body: { taskIds: string[], assignedTo: string, reason?: string }
- Response: { success: boolean, results: Array<{taskId: string, success: boolean}> }
- Auth: Lead MR, Admin
```

**Task Status Management APIs:**
```
PUT /api/tasks/[id]/status
- Body: { status: TaskStatus, notes?: string }
- Response: { success: boolean, task: Task }
- Auth: Assigned user, Lead MR, Admin

PUT /api/tasks/[id]/complete
- Body: { completionNotes?: string, completionTime?: DateTime }
- Response: { success: boolean, task: Task }
- Auth: Assigned user, Lead MR, Admin

GET /api/tasks/[id]/history
- Response: TaskHistory[] with pagination
- Auth: Assigned user, Lead MR, Admin
```

**Task Notification APIs:**
```
GET /api/tasks/notifications
- Query params: isRead?, type?, limit?
- Response: TaskNotification[] with pagination
- Auth: Authenticated users (own notifications)

PUT /api/tasks/notifications/[id]/read
- Response: { success: boolean }
- Auth: Notification owner

POST /api/tasks/notifications/send
- Body: { taskId: string, userId: string, type: NotificationType, message: string }
- Response: { success: boolean }
- Auth: Lead MR, Admin
```

**Task Analytics APIs:**
```
GET /api/tasks/analytics/completion-rate
- Query params: userId?, region?, dateFrom?, dateTo?
- Response: { completionRate: number, totalTasks: number, completedTasks: number }
- Auth: User (own data), Lead MR (team data), Admin (all data)

GET /api/tasks/analytics/efficiency
- Query params: userId?, region?, period?
- Response: { avgCompletionTime: number, efficiency: number, trends: Array<TrendData> }
- Auth: User (own data), Lead MR (team data), Admin (all data)

GET /api/tasks/analytics/overdue
- Query params: userId?, region?
- Response: { overdueTasks: number, overdueRate: number, tasks: Task[] }
- Auth: User (own data), Lead MR (team data), Admin (all data)
```

**Task Template APIs:**
```
GET /api/tasks/templates
- Query params: region?, isActive?
- Response: TaskTemplate[] with pagination
- Auth: All authenticated users

POST /api/tasks/templates
- Body: { name, description?, region?, area?, priority?, estimatedDuration? }
- Response: Created template data
- Auth: Lead MR, Admin

POST /api/tasks/from-template
- Body: { templateId: string, assignedTo?: string, dueDate?: DateTime }
- Response: Created task from template
- Auth: Lead MR, Admin
```

[Source: docs/architecture/backend-architecture.md#api-design]

### Component Specifications
**Task Management Components:**
- Task listing with advanced filtering and search
- Task creation and editing forms
- Task assignment interface with user selection
- Task status management with workflow validation
- Task priority and due date management
- Task template management interface

**Task Analytics Components:**
- Task completion rate visualization
- Task efficiency metrics and trends
- Task performance comparisons
- Task overdue tracking and alerts
- Task audit trail and history display

**Task Notification Components:**
- Real-time notification system
- Notification preferences management
- Notification delivery tracking
- Push notification integration

[Source: docs/architecture/dashboard-architecture.md#component-architecture]

### File Locations
- Task API routes: `src/app/api/tasks/`
  - Task management: `src/app/api/tasks/route.ts`
  - Task assignment: `src/app/api/tasks/[id]/assign/`
  - Task status: `src/app/api/tasks/[id]/status/`
  - Task analytics: `src/app/api/tasks/analytics/`
  - Task templates: `src/app/api/tasks/templates/`
- Task components: `src/components/tasks/`
  - Task table: `src/components/tasks/task-table.tsx`
  - Task form: `src/components/tasks/task-form.tsx`
  - Task assignment: `src/components/tasks/task-assignment.tsx`
  - Task analytics: `src/components/tasks/task-analytics.tsx`
- Task utilities: `src/lib/task-utils.ts`
- Task analytics: `src/lib/task-analytics.ts`

[Source: docs/architecture/dashboard-architecture.md#application-structure]

### Testing Requirements
- Unit tests for task management workflows
- Integration tests for task assignment logic
- E2E tests for task creation and completion
- Performance tests for task analytics
- Notification system tests
- Template system tests
- Bulk operations tests

### Technical Constraints
- Next.js API routes with TypeScript
- Prisma for database operations
- Real-time notifications with WebSocket
- Task assignment conflict prevention
- Performance optimization for large task datasets
- Role-based access control for all operations

[Source: docs/architecture/backend-architecture.md#technology-stack]

### Environment Variables Required
- `DATABASE_URL`: MongoDB connection (from Story 1.2)
- `NEXTAUTH_SECRET`: JWT signing secret (from Story 1.3)
- `NOTIFICATION_SERVICE_URL`: Push notification service URL
- `EMAIL_SERVICE_KEY`: Email notification service key
- `NODE_ENV`: Environment (development/production)

### Security Considerations
- Role-based access control for task operations
- Task assignment validation and constraints
- Audit logging for all task changes
- Notification security and privacy
- Task data encryption and protection

### Performance Considerations
- Efficient task querying with proper indexing
- Real-time notification delivery optimization
- Task analytics calculation optimization
- Bulk operations performance
- Task history and audit trail optimization

## Testing
- Test task creation and assignment workflows
- Test task status management and completion
- Test notification system functionality
- Test task analytics and reporting
- Test template system and bulk operations
- Test role-based access control
- Test performance with large task datasets

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| [Current Date] | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
[To be filled by Dev Agent]

### Debug Log References
[To be filled by Dev Agent]

### Completion Notes List
[To be filled by Dev Agent]

### File List
[To be filled by Dev Agent]

## QA Results
[To be filled by QA Agent] 