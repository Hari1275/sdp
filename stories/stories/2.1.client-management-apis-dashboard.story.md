# Story 2.1: Client Management APIs and Dashboard

## Status
Draft

## Story
**As a** Lead MR or Admin user,
**I want** comprehensive client management APIs and dashboard interface,
**so that** I can efficiently manage client data, track business relationships, and provide field teams with accurate client information

## Acceptance Criteria
1. Client management APIs are enhanced with advanced filtering and search capabilities
2. Client dashboard displays all clients with comprehensive filtering options
3. Client creation form includes all required fields with validation
4. Client editing functionality allows updating all client information
5. Client search functionality works across name, phone, business type, and location
6. Client data export functionality is implemented (CSV/Excel)
7. Client location mapping integration is available
8. Duplicate client prevention logic is implemented
9. Client business history tracking is available
10. Role-based access control is enforced (MR, Lead MR, Admin)
11. Responsive design works on desktop and tablet devices
12. Real-time data updates when clients are modified

## Tasks / Subtasks
- [ ] Enhance client management APIs (AC: 1, 8)
  - [ ] Implement advanced filtering by region, area, business type
  - [ ] Add search functionality across multiple fields
  - [ ] Implement duplicate prevention logic (name + area + region)
  - [ ] Add pagination for large client datasets
  - [ ] Create client statistics API endpoints
- [ ] Build client dashboard interface (AC: 2, 5, 11)
  - [ ] Create client listing page with data table
  - [ ] Implement advanced filtering and search UI
  - [ ] Add client statistics and overview cards
  - [ ] Create responsive layout for desktop and tablet
  - [ ] Implement sorting and pagination controls
- [ ] Implement client creation and editing (AC: 3, 4)
  - [ ] Create comprehensive client creation form
  - [ ] Implement form validation with error handling
  - [ ] Create client editing modal/form
  - [ ] Add GPS coordinate capture functionality
  - [ ] Implement business type dropdown with validation
- [ ] Add client search and filtering (AC: 5)
  - [ ] Implement real-time search across client fields
  - [ ] Create filter controls for region, area, business type
  - [ ] Add date range filtering for client creation
  - [ ] Implement search result highlighting
- [ ] Implement data export functionality (AC: 6)
  - [ ] Create CSV export for client data
  - [ ] Implement Excel export with formatting
  - [ ] Add export filtering options
  - [ ] Create export progress indicators
- [ ] Add client location mapping (AC: 7)
  - [ ] Integrate map component for client locations
  - [ ] Implement client marker display on map
  - [ ] Add location validation and error handling
  - [ ] Create map-based client discovery
- [ ] Implement business history tracking (AC: 9)
  - [ ] Create client business history view
  - [ ] Display business entries for each client
  - [ ] Add business statistics and trends
  - [ ] Implement business entry filtering
- [ ] Implement security and access control (AC: 10)
  - [ ] Enforce role-based access control for client operations
  - [ ] Implement region-based data filtering for MRs
  - [ ] Add audit logging for client operations
  - [ ] Create access control middleware for client routes
- [ ] Add real-time data updates (AC: 12)
  - [ ] Implement React Query for client data management
  - [ ] Add optimistic updates for client operations
  - [ ] Create real-time notification system
  - [ ] Implement data synchronization

## Dev Notes

### Previous Story Insights
This story builds on Epic 1 (Stories 1.1-1.5). The developer should have:
- Complete Next.js foundation with TypeScript and Prisma
- MongoDB schema with Client and BusinessEntry models
- User authentication system with role-based access
- Core API endpoints for client management
- Admin dashboard with user management

### Data Models
**Client Model (from Story 1.2):**
```typescript
model Client {
  id           String @id @default(auto()) @map("_id") @db.ObjectId
  name         String
  phone        String?
  businessType String
  area         String
  region       String
  latitude     Float?
  longitude    Float?
  createdBy    String @db.ObjectId
  user         User   @relation(fields: [createdBy], references: [id])
  businessEntries BusinessEntry[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([name, area, region]) // Prevent duplicates
  @@index([region, area])
  @@index([createdBy])
  @@index([name, area, region])
}

model BusinessEntry {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  amount    Float
  notes     String?
  clientId  String   @db.ObjectId
  client    Client   @relation(fields: [clientId], references: [id])
  createdBy String   @db.ObjectId
  user      User     @relation(fields: [createdBy], references: [id])
  latitude  Float?
  longitude Float?
  createdAt DateTime @default(now())

  @@index([clientId])
  @@index([createdBy])
  @@index([createdAt])
}
```

[Source: docs/architecture/backend-architecture.md#database-schema-design]

### API Specifications
**Enhanced Client Management APIs:**
```
GET /api/clients
- Query params: region?, area?, businessType?, search?, page?, limit?
- Response: PaginatedResponse<Client[]> with role-based filtering
- Auth: All authenticated users (filtered by role)

POST /api/clients
- Body: { name, phone?, businessType, area, region, latitude?, longitude? }
- Response: Created client data with duplicate validation
- Auth: MR, Lead MR, Admin

PUT /api/clients/[id]
- Body: { name?, phone?, businessType?, area?, region?, latitude?, longitude? }
- Response: Updated client data
- Auth: Admin only

DELETE /api/clients/[id]
- Response: { success: boolean }
- Auth: Admin only

GET /api/clients/search
- Query params: q (search term), region?, area?
- Response: Client[] with search highlighting
- Auth: All authenticated users (filtered by role)

GET /api/clients/[id]/business
- Response: BusinessEntry[] for specific client
- Auth: All authenticated users (filtered by role)

GET /api/clients/statistics
- Query params: region?, area?, dateFrom?, dateTo?
- Response: Client statistics and metrics
- Auth: All authenticated users (filtered by role)

POST /api/clients/export
- Body: { format: 'csv' | 'excel', filters: {...} }
- Response: Export file download
- Auth: Lead MR, Admin
```

[Source: docs/architecture/backend-architecture.md#api-design]

### Component Specifications
**Client Dashboard Components:**
- Client listing table with advanced filtering
- Client search bar with real-time results
- Client statistics cards (total clients, active clients, business types)
- Client creation and editing forms
- Client detail view with business history
- Map component for client locations
- Export functionality interface

**Client Management Forms:**
- Client creation form with all required fields
- Client editing modal with validation
- Business type selection dropdown
- GPS coordinate input with map integration
- Region and area selection with hierarchical display

**Client Search and Filter:**
- Real-time search input with debouncing
- Advanced filter panel with multiple criteria
- Search result highlighting
- Filter state management and persistence

[Source: docs/architecture/dashboard-architecture.md#component-architecture]

### File Locations
- Client pages: `src/app/dashboard/clients/`
  - Client listing: `src/app/dashboard/clients/page.tsx`
  - Client detail: `src/app/dashboard/clients/[id]/page.tsx`
  - Client creation: `src/app/dashboard/clients/create/page.tsx`
- Components: `src/components/clients/`
  - Client table: `src/components/clients/client-table.tsx`
  - Client form: `src/components/clients/client-form.tsx`
  - Client search: `src/components/clients/client-search.tsx`
  - Client map: `src/components/clients/client-map.tsx`
- API integration: `src/hooks/use-clients.ts`
- Client utilities: `src/lib/client-utils.ts`

[Source: docs/architecture/dashboard-architecture.md#application-structure]

### Testing Requirements
- Unit tests for client components
- Integration tests for client management workflows
- E2E tests for client creation and editing
- Role-based access control tests
- Search and filtering functionality tests
- Export functionality tests
- Map integration tests

### Technical Constraints
- Next.js with App Router
- TypeScript for type safety
- Tailwind CSS for styling
- shadcn/ui for base components
- React Query for data fetching
- Leaflet for map integration
- NextAuth.js for authentication
- Role-based access control

[Source: docs/architecture/dashboard-architecture.md#technology-stack]

### Environment Variables Required
- `DATABASE_URL`: MongoDB connection (from Story 1.2)
- `NEXTAUTH_SECRET`: JWT signing secret (from Story 1.3)
- `NEXTAUTH_URL`: Application URL
- `NODE_ENV`: Environment (development/production)
- `MAP_API_KEY`: Map service API key (if required)

### Security Considerations
- Role-based access control for client operations
- Region-based data filtering for MRs
- Input validation and sanitization
- Audit logging for client operations
- CSRF protection for forms
- Data export security and validation

### Design System Requirements
**Color Scheme:**
- Primary: Deep Green (#1B5E20)
- Secondary: Warm Orange (#FF6B35)
- Accent: Soft Blue (#4A90E2)
- Background: Light Gray (#F8F9FA)

**Typography:**
- Primary Font: Inter
- Headers: 32px (H1), 24px (H2), 20px (H3)
- Body: 16px, Small: 14px

**Layout:**
- Sidebar: 280px width (desktop), overlay (mobile)
- Header: 64px height
- Content padding: 24px (desktop), 16px (mobile)
- Card border radius: 12px

[Source: docs/ux/front-end-specifications.md#design-system-overview]

## Testing
- Test client creation with all field validations
- Test client editing and update functionality
- Test search and filtering across multiple criteria
- Test duplicate prevention logic
- Test role-based access control for different user types
- Test export functionality with various formats
- Test map integration and location validation
- Test responsive design on different screen sizes

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| [Current Date] | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
[To be filled by Dev Agent]

### Debug Log References
[To be filled by Dev Agent]

### Completion Notes List
[To be filled by Dev Agent]

### File List
[To be filled by Dev Agent]

## QA Results
[To be filled by QA Agent] 