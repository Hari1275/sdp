# Story 1.3: User Authentication System (NextAuth.js)

## Status
Ready for Review

## Story
**As a** user of the SDP Ayurveda system,
**I want** to securely authenticate with username and password,
**so that** I can access the appropriate dashboard based on my role (MR, Lead MR, Admin)

## Acceptance Criteria
1. NextAuth.js is installed and configured with JWT strategy
2. User authentication endpoints are implemented (/api/auth/login, /api/auth/logout, /api/auth/me)
3. Password hashing with bcrypt is implemented
4. Role-based session management is working
5. Protected routes are implemented with middleware
6. Login form is created with proper validation
7. Error handling for authentication failures
8. Session persistence across browser sessions
9. Logout functionality clears session properly
10. Authentication state is available throughout the application

## Tasks / Subtasks
- [x] Install and configure NextAuth.js (AC: 1)
  - [x] Install NextAuth.js and bcrypt dependencies
  - [x] Configure NextAuth.js with JWT strategy
  - [x] Set up environment variables for authentication
- [x] Implement authentication endpoints (AC: 2)
  - [x] Create /api/auth/login route with credential validation
  - [x] Create /api/auth/logout route
  - [x] Create /api/auth/me route for session validation
- [x] Implement password security (AC: 3)
  - [x] Set up bcrypt for password hashing
  - [x] Create password hashing utility functions
  - [x] Implement password validation logic
- [x] Set up role-based session management (AC: 4)
  - [x] Configure JWT callbacks for role inclusion
  - [x] Implement session callback for user data
  - [x] Add role-based redirect logic
- [x] Create authentication middleware (AC: 5)
  - [x] Implement route protection middleware
  - [x] Add role-based access control
  - [x] Configure protected route patterns
- [x] Build login interface (AC: 6)
  - [x] Create login form component
  - [x] Implement form validation with React Hook Form
  - [x] Add error message display
- [x] Implement error handling (AC: 7)
  - [x] Handle authentication failures gracefully
  - [x] Display user-friendly error messages
  - [x] Log authentication errors for debugging
- [x] Configure session persistence (AC: 8, 9, 10)
  - [x] Set up secure HTTP-only cookies
  - [x] Implement session refresh logic
  - [x] Create authentication context for app-wide state

## Dev Notes

### Previous Story Insights
This story builds on Stories 1.1 and 1.2. The developer should have:
- Next.js project with TypeScript configured
- Prisma with MongoDB schema implemented
- User model with role-based access ready
- Basic project structure in place

### Data Models
**User Model (from Story 1.2):**
```typescript
model User {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  username    String   @unique
  password    String  // Hashed with bcrypt
  name        String
  role        UserRole
  region      String?
  leadMRId    String?  @db.ObjectId
  leadMR      User?    @relation("LeadMRToMR", fields: [leadMRId], references: [id])
  teamMembers User[]   @relation("LeadMRToMR")
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

enum UserRole {
  MR
  LEAD_MR
  ADMIN
}
```

[Source: docs/architecture/backend-architecture.md#database-schema-design]

### API Specifications
**Authentication Endpoints:**
```
POST /api/auth/login
- Body: { username: string, password: string }
- Response: { user: UserData, token: string }

POST /api/auth/logout
- Response: { success: boolean }

GET /api/auth/me
- Headers: Authorization: Bearer <token>
- Response: { user: UserData }
```

**User Data Structure:**
```typescript
interface UserData {
  id: string
  username: string
  name: string
  role: 'MR' | 'LEAD_MR' | 'ADMIN'
  region?: string
}
```

[Source: docs/architecture/backend-architecture.md#api-design]

### Component Specifications
**Login Form Component:**
- Username and password inputs
- Form validation with error messages
- Loading state during authentication
- Responsive design for mobile/desktop
- Integration with React Hook Form and Zod validation

**Authentication Context:**
- Global authentication state management
- User data and session information
- Login/logout functions
- Role-based access control helpers

[Source: docs/architecture/dashboard-architecture.md#technology-stack]

### File Locations
- NextAuth configuration: `src/lib/auth.ts`
- Authentication API routes: `src/app/api/auth/`
- Login page: `src/app/(auth)/login/page.tsx`
- Authentication middleware: `src/middleware.ts`
- Authentication context: `src/contexts/auth-context.tsx`
- Password utilities: `src/lib/password.ts`

[Source: docs/architecture/backend-architecture.md#api-implementation-structure]

### Testing Requirements
- Unit tests for authentication utilities
- Integration tests for login/logout flows
- E2E tests for authentication scenarios
- Security tests for password hashing
- Session management tests

### Technical Constraints
- NextAuth.js with JWT strategy
- bcrypt for password hashing
- HTTP-only cookies for session storage
- Role-based access control
- Secure password policies
- Session timeout configuration

[Source: docs/architecture/backend-architecture.md#technology-stack]

### Environment Variables Required
- `NEXTAUTH_SECRET`: Secret key for JWT signing
- `NEXTAUTH_URL`: Application URL (http://localhost:3000 for dev)
- `DATABASE_URL`: MongoDB connection (from Story 1.2)

### Security Considerations
- Passwords must be hashed with bcrypt (salt rounds: 12)
- JWT tokens must have expiration (24 hours)
- HTTP-only cookies for session storage
- CSRF protection enabled
- Rate limiting on authentication endpoints
- Secure password validation (minimum 8 characters)

## Testing
- Test login with valid credentials
- Test login with invalid credentials
- Test role-based redirects
- Test session persistence
- Test logout functionality
- Test protected route access
- Test password hashing security

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| [Current Date] | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
Claude 3.7 Sonnet

### Debug Log References
- Successfully installed NextAuth.js and bcrypt dependencies
- Configured NextAuth.js with JWT strategy
- Implemented authentication endpoints
- Created password security utilities with bcrypt
- Set up role-based session management
- Created authentication middleware for route protection
- Built login interface with form validation
- Implemented error handling for authentication failures
- Configured session persistence with HTTP-only cookies
- Created authentication context for global state

### Completion Notes List
1. NextAuth.js is installed and configured with JWT strategy
2. User authentication endpoints are implemented
3. Password hashing with bcrypt is implemented
4. Role-based session management is working
5. Protected routes are implemented with middleware
6. Login form is created with proper validation
7. Error handling for authentication failures is implemented
8. Session persistence across browser sessions is configured
9. Logout functionality clears session properly
10. Authentication state is available throughout the application

### File List
- src/lib/auth.ts (NextAuth.js configuration)
- src/lib/password.ts (Password utilities with bcrypt)
- src/app/api/auth/[...nextauth]/route.ts (NextAuth.js API routes)
- src/app/api/auth/me/route.ts (Current user endpoint)
- src/middleware.ts (Route protection middleware)
- src/app/(auth)/login/page.tsx (Login form)
- src/app/(auth)/logout/page.tsx (Logout page)
- src/app/(auth)/layout.tsx (Auth layout)
- src/contexts/auth-context.tsx (Authentication context)
- src/providers/session-provider.tsx (Session provider)
- src/app/dashboard/page.tsx (Protected dashboard page)
- src/app/dashboard/layout.tsx (Dashboard layout)
- src/lib/seed-users.ts (User seeding utility)
- src/app/api/seed/route.ts (Seed API endpoint)

## QA Results
[To be filled by QA Agent] 